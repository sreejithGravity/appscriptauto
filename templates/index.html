<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Income & Expense Logger</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f5f7fb;
      color: #111827;
    }
    header {
      background: #111827;
      color: white;
      padding: 18px 24px;
    }
    .container {
      max-width: 980px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      margin-bottom: 18px;
    }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-12 { grid-column: span 12; }
    label { display:block; margin-bottom:6px; font-weight:600; }
    input, select, textarea {
      width: 100%; padding: 10px 12px;
      border-radius: 10px; border: 1px solid #e5e7eb; background: #fff;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }
    .radio-group { display:flex; gap:12px; align-items:center; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 16px; border-radius: 10px; border: none; cursor: pointer;
      font-weight: 600;
    }
    .btn-primary { background: #6366f1; color:white; }
    .btn-secondary { background: #e5e7eb; }
    .actions { display:flex; gap: 10px; }
    .hint { color:#6b7280; font-size: 12px; margin-top:4px; }
    .badge {
      display:inline-block; padding:4px 8px; border-radius:9999px;
      background:#eef2ff; color:#4338ca; font-size:12px; font-weight:700;
    }
    .header-row { display:flex; align-items:center; justify-content:space-between; }
    .muted { color:#6b7280; }
    .success { background: #ecfdf5; border:1px solid #10b98133; color:#065f46; padding:12px; border-radius:10px; }
    .error { background: #fef2f2; border:1px solid #ef444433; color:#991b1b; padding:12px; border-radius:10px; }
  </style>
</head>
<body>
  <header>
    <div class="container header-row">
      <h2>Income & Expense Logger</h2>
      <span class="badge" id="today"></span>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <div class="col-12">
          <div id="status" class="muted">Ready.</div>
        </div>
      </div>
      <form id="txForm" onsubmit="handleSubmit(event)">
        <div class="row">
          <div class="col-4">
            <label>Type</label>
            <div class="radio-group">
              <label><input type="radio" name="type" value="Income" checked> Income</label>
              <label><input type="radio" name="type" value="Expense"> Expense</label>
            </div>
          </div>
          <div class="col-4">
            <label for="date">Date</label>
            <input type="date" id="date" required>
          </div>
          <div class="col-4">
            <label for="amount">Amount</label>
            <input type="number" id="amount" min="0" step="0.01" placeholder="0.00" required>
          </div>

          <div class="col-4">
            <label for="category">Category</label>
            <select id="category" required></select>
            <div class="hint">Options change based on Type.</div>
          </div>
          <div class="col-4">
            <label for="subcategory">Subcategory</label>
            <input type="text" id="subcategory" placeholder="Optional">
          </div>
          <div class="col-4">
            <label for="account">Account</label>
            <select id="account"></select>
          </div>

          <div class="col-4">
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod"></select>
          </div>
          <div class="col-4">
            <label for="tags">Tags</label>
            <input type="text" id="tags" placeholder="e.g., office, travel">
          </div>
          <div class="col-12">
            <label for="description">Description</label>
            <textarea id="description" rows="3" placeholder="Add a note"></textarea>
          </div>
          <div class="col-12">
            <label for="receiptUrl">Receipt URL</label>
            <input type="url" id="receiptUrl" placeholder="https://...">
            <div class="hint">Paste a link to Drive/Dropbox or any receipt URL.</div>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="col-12 actions">
            <button class="btn btn-primary" type="submit">Save Transaction</button>
            <button class="btn btn-secondary" type="button" onclick="resetForm()">Reset</button>
          </div>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="row">
        <div class="col-12">
          <h3 style="margin:0 0 8px;">Tips</h3>
          <ul class="muted">
            <li>Run <strong>setup()</strong> from the Apps Script editor to create the necessary sheets.</li>
            <li>Edit the <strong>Meta</strong> sheet to customize categories, accounts, and payment methods.</li>
            <li>See <strong>Monthly Summary</strong> and <strong>Account Balances</strong> sheets for auto summaries.</li>
          </ul>
        </div>
      </div>
    </div>

    <div id="toast" style="position:fixed;right:16px;bottom:16px;"></div>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const state = { meta: null };

    function showToast(msg, ok=true) {
      const t = document.getElementById('toast');
      t.innerHTML = '<div class="' + (ok ? 'success' : 'error') + '">' + msg + '</div>';
      setTimeout(() => t.innerHTML = '', 3500);
    }

    function setTodayBadge() {
      const d = new Date();
      const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), da = String(d.getDate()).padStart(2,'0');
      document.getElementById('today').textContent = y + '-' + m + '-' + da;
      el('date').value = y + '-' + m + '-' + da;
    }

    function onTypeChange() {
      const type = document.querySelector('input[name="type"]:checked').value;
      const catSelect = el('category');
      catSelect.innerHTML = '';
      const cats = (state.meta && state.meta.categoriesByType[type]) || [];
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        catSelect.appendChild(opt);
      });
      if (!cats.length) {
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = '— add categories in Meta sheet —';
        catSelect.appendChild(opt);
      }
    }

    function loadMeta() {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        el('status').textContent = 'Loading options...';
        google.script.run.withSuccessHandler((meta) => {
          state.meta = meta;
          // Accounts
          const accSel = el('account');
          accSel.innerHTML = '';
          (meta.accounts || []).forEach(a => {
            const o = document.createElement('option');
            o.value = a; o.textContent = a; accSel.appendChild(o);
          });
          // Payment methods
          const pmSel = el('paymentMethod');
          pmSel.innerHTML = '';
          (meta.paymentMethods || []).forEach(p => {
            const o = document.createElement('option');
            o.value = p; o.textContent = p; pmSel.appendChild(o);
          });
          // Categories by type
          onTypeChange();
          el('status').textContent = 'Ready.';
        }).getMeta();
      } else {
        el('status').textContent = 'Running locally (preview). Apps Script features will work when deployed.';
      }
    }

    function handleSubmit(e) {
      e.preventDefault();
      const payload = {
        type: document.querySelector('input[name="type"]:checked').value,
        date: el('date').value,
        category: el('category').value,
        subcategory: el('subcategory').value,
        amount: el('amount').value,
        account: el('account').value,
        paymentMethod: el('paymentMethod').value,
        tags: el('tags').value,
        description: el('description').value,
        receiptUrl: el('receiptUrl').value
      };

      if (!payload.amount || !payload.category) {
        showToast('Please fill the required fields (Amount, Category).', false);
        return;
      }

      if (typeof google !== 'undefined' && google.script && google.script.run) {
        el('status').textContent = 'Saving...';
        google.script.run.withSuccessHandler(() => {
          showToast('Saved!');
          el('status').textContent = 'Saved.';
          resetForm();
        }).withFailureHandler(err => {
          showToast(err.message || 'Failed to save.', false);
          el('status').textContent = 'Error: ' + (err.message || err);
        }).submitTransaction(payload);
      } else {
        showToast('This is a static preview. Deploy as Apps Script to save.', false);
      }
    }

    function resetForm() {
      el('amount').value = '';
      el('subcategory').value = '';
      el('tags').value = '';
      el('description').value = '';
      el('receiptUrl').value = '';
      onTypeChange();
    }

    document.addEventListener('DOMContentLoaded', () => {
      setTodayBadge();
      loadMeta();
      document.querySelectorAll('input[name="type"]').forEach(r =>
        r.addEventListener('change', onTypeChange)
      );
    });
  </script>
</body>
</html>